<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FATmax Pro v6.3 (Residual Filter)</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; max-width: 950px; margin: 0 auto; padding: 20px; background: #f8f9fa; color: #343a40; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e9ecef; }
        h1 { color: #d63384; text-align: center; margin: 0 0 5px 0; }
        .subtitle { text-align: center; color: #6c757d; font-size: 0.9em; margin-bottom: 25px; }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 700px) { .input-grid { grid-template-columns: 1fr; } }
        
        .col-title { font-weight: bold; text-align: center; margin-bottom: 10px; padding: 8px; border-radius: 6px; color: white; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.85em; }
        .bg-a { background: linear-gradient(135deg, #d63384 0%, #c2185b 100%); }
        .bg-b { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); }
        
        label { display: block; margin-top: 10px; font-size: 0.85em; font-weight: 600; color: #495057; }
        input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-family: monospace; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: #d63384; outline: none; }
        
        button { background: #212529; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.2s; }
        button:hover { background: #343a40; transform: translateY(-1px); }
        
        .loading { background: #fff3cd; color: #856404; padding: 15px; border-radius: 6px; text-align: center; margin-bottom: 20px; border: 1px solid #ffeeba; }
        .error { color: #842029; background: #f8d7da; padding: 10px; border-radius: 6px; text-align: center; margin-top: 15px; display: none; border: 1px solid #f5c2c7; }
        
        /* WARNING BOX STYLES */
        .warning-container { margin-top: 15px; display: none; }
        .warning-box { 
            background-color: #fff3cd; 
            color: #664d03; 
            border: 1px solid #ffecb5; 
            padding: 12px; 
            border-radius: 6px; 
            font-size: 0.9em;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }
        .warning-icon { margin-right: 10px; font-size: 1.2em; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; background: white; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; }
        th { background: #f1f3f5; color: #495057; text-transform: uppercase; font-size: 0.8em; letter-spacing: 0.5px; }
        .metric { text-align: left; font-weight: 700; color: #212529; }
        .val-a { color: #d63384; font-weight: 700; }
        .val-b { color: #0d6efd; font-weight: 700; }
        .sub-header { background: #e9ecef; font-weight: bold; text-align: left; padding-left: 15px; font-size: 0.8em; color: #6c757d; }
    </style>
</head>
<body>

    <div class="card">
        <h1>üî• FATmax Pro v6.3</h1>
        <p class="subtitle">Poly-Residual Filter + Automated Quality Checks</p>

        <div id="loader" class="loading">
            ‚è≥ <b>Loading Scientific Environment...</b><br>
            <small>Initializing NumPy, SciPy & Pandas...</small>
        </div>

        <div id="ui" style="display:none;">
            <div class="input-grid">
                <div>
                    <div class="col-title bg-a">Subject A (Main)</div>
                    <label>Speed / Power</label>
                    <input type="text" id="sa" value="4, 5, 6, 7, 8, 9, 10">
                    <label>Fat Oxidation (g/min)</label>
                    <input type="text" id="fa" value="0.25, 0.35, 1.85, 0.65, 0.50, 0.20, 0.05">
                    <small style="color:#888;">(Example with outlier included)</small>
                </div>
                <div>
                    <div class="col-title bg-b">Subject B (Comparison)</div>
                    <label>Speed / Power</label>
                    <input type="text" id="sb" value="" placeholder="Optional">
                    <label>Fat Oxidation (g/min)</label>
                    <input type="text" id="fb" value="" placeholder="Optional">
                </div>
            </div>
            
            <div style="margin-top:15px; font-size:0.85em; background:#e2e3e5; padding:10px; border-radius:5px;">
                <label style="display:inline; margin:0;">
                    <input type="checkbox" id="chk_filter" checked style="width:auto; margin-right:5px;"> 
                    <b>Shape-Aware Filter:</b> Remove points deviating from polynomial trend (Residual Z > 1.96).
                </label>
            </div>

            <button id="btn_calc">RUN ANALYSIS</button>
            <div id="err_msg" class="error"></div>
            
            <div id="warn_container" class="warning-container">
                <div id="warn_a" class="warning-box" style="display:none;"></div>
                <div id="warn_b" class="warning-box" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div id="results" class="card" style="display:none;">
        <h3 style="text-align:center; margin-top:0; color:#495057;">Analysis Report</h3>
        <div id="table_out"></div>
        <div id="plot_out" style="display:flex; justify-content:center; margin-top:25px;"></div>
    </div>

    <py-config>
        packages = ["numpy", "scipy", "matplotlib", "pandas"]
    </py-config>

    <script type="py">
        import numpy as np
        import pandas as pd
        import matplotlib.pyplot as plt
        from scipy.optimize import curve_fit
        from js import document
        from pyodide.ffi import create_proxy
        from pyscript import display

        # 1. Init
        def init():
            document.getElementById("loader").style.display = "none"
            document.getElementById("ui").style.display = "block"
        init()

        # 2. SIN Model
        def model_sin(x, A, s, d, t, K):
            pi = np.pi
            linear = K * x + d + t
            mask = (linear > 0)
            y = np.zeros_like(x, dtype=float)
            if np.sum(mask) == 0: return y
            
            num = pi**(1/s)
            den = pi + 2*d
            base = np.zeros_like(x, dtype=float)
            base[mask] = (num / den) * linear[mask]
            
            arg = np.zeros_like(x, dtype=float)
            safe = (base > 0) & mask
            arg[safe] = base[safe] ** s
            
            y[safe] = A * np.sin(arg[safe])
            y[arg > pi] = 0
            y[y < 0] = 0
            return y

        # 3. POLY-RESIDUAL FILTER (New logic v6.3)
        def apply_filter(x, y):
            if len(y) < 4: return x, y, [], []
            
            # A. Fit a robust 3rd degree polynomial to capture general shape
            try:
                # Weights: giving slightly less weight to extreme y values initially
                coeffs = np.polyfit(x, y, 3) 
                poly_curve = np.poly1d(coeffs)
                y_pred = poly_curve(x)
                
                # B. Calculate Residuals
                residuals = np.abs(y - y_pred)
                
                # C. Calculate Robust Z-Score of residuals
                # Use Median Absolute Deviation (MAD) for robustness
                median_res = np.median(residuals)
                mad_res = np.median(np.abs(residuals - median_res))
                
                if mad_res == 0: mad_res = 1e-9 # Prevent div/0
                
                # Standard consistency constant for MAD -> Sigma
                sigma_est = 1.4826 * mad_res
                
                z_scores = (residuals - median_res) / sigma_est
                
                # D. Threshold: Z > 2.5 (Strict but fair for small N)
                mask_out = z_scores > 2.5
                
                # Safety: Don't filter if it removes > 50% of data
                if np.sum(mask_out) > (len(y) / 2):
                    return x, y, [], []
                
                return x[~mask_out], y[~mask_out], x[mask_out], y[mask_out]

            except:
                # Fallback if polyfit fails
                return x, y, [], []

        # 4. Metrics
        def calc_metrics(y_true, y_pred, n_params=5):
            residuals = y_true - y_pred
            ss_res = np.sum(residuals**2)
            ss_tot = np.sum((y_true - np.mean(y_true))**2)
            if ss_tot == 0: r2 = 0.0
            else: r2 = 1 - (ss_res / ss_tot)
            
            n = len(y_true)
            if ss_res <= 0: ss_res = 1e-9
            aic = n * np.log(ss_res / n) + 2 * n_params
            return r2, aic

        # 5. Analysis Engine
        def analyze(x_raw, y_raw, use_filter=True):
            warnings = []
            try:
                if use_filter:
                    x_fit, y_fit, x_out, y_out = apply_filter(x_raw, y_raw)
                else:
                    x_fit, y_fit = x_raw, y_raw
                    x_out, y_out = [], []

                if len(x_fit) < 4: 
                    return {"error": "Not enough valid data points. Check inputs."}

                # Initial Guesses
                p0_A = np.max(y_fit)
                rng = np.max(x_fit) - np.min(x_fit)
                scale = rng if rng > 0 else 1
                p0_K = np.pi / (scale + 1)
                p0_t = -p0_K * np.min(x_fit)
                
                # Bounds
                bds = ([0, 0.1, -5.0, -np.inf, 0], [np.inf, 10, 50, np.inf, np.inf])
                
                # Fit
                popt, pcov = curve_fit(model_sin, x_fit, y_fit, p0=[p0_A, 1.0, 0.0, p0_t, p0_K], bounds=bds, maxfev=10000)
                
                # Check Bounds/Warnings
                if popt[1] > 9.9: warnings.append("‚ö†Ô∏è Symmetry parameter saturated. Curve may be non-physiological.")
                if popt[2] > 49: warnings.append("‚ö†Ô∏è Dilatation parameter saturated.")

                # Curve Gen
                xs = np.linspace(min(x_raw), max(x_raw)+2, 200)
                ys = model_sin(xs, *popt)
                idx = np.argmax(ys)
                
                mfo = ys[idx]
                fatmax = xs[idx]
                fatmin = (np.pi + popt[2] - popt[3]) / popt[4]
                
                z_idx = np.where(ys >= 0.9 * mfo)[0]
                if len(z_idx) > 0: z_lo, z_hi = xs[z_idx[0]], xs[z_idx[-1]]
                else: z_lo, z_hi = fatmax, fatmax

                # Quality Metrics
                y_pred_fit = model_sin(x_fit, *popt)
                r2, aic = calc_metrics(y_fit, y_pred_fit)
                
                if r2 < 0.70: warnings.append(f"‚ö†Ô∏è Poor Fit Quality (R¬≤={r2:.2f}). Data is highly scattered.")
                if len(x_out) > 0: warnings.append(f"‚ÑπÔ∏è {len(x_out)} outlier(s) automatically removed.")

                return {
                    "xs": xs, "ys": ys,
                    "x_fit": x_fit, "y_fit": y_fit, "x_out": x_out, "y_out": y_out,
                    "mfo": mfo, "fm": fatmax, "fmin": fatmin,
                    "zlo": z_lo, "zhi": z_hi,
                    "sym": popt[1], "dil": popt[2],
                    "r2": r2, "aic": aic, "n_out": len(x_out),
                    "warnings": warnings
                }
            except Exception as e: return {"error": str(e)}

        # 6. Main Handler
        def run_click(event):
            # Reset UI
            document.getElementById("err_msg").style.display = "none"
            document.getElementById("warn_container").style.display = "none"
            document.getElementById("warn_a").style.display = "none"
            document.getElementById("warn_b").style.display = "none"
            document.getElementById("plot_out").innerHTML = ""
            document.getElementById("table_out").innerHTML = ""
            
            try:
                do_filter = document.getElementById("chk_filter").checked
                
                # ANALYZE A
                str_sa = document.getElementById("sa").value
                str_fa = document.getElementById("fa").value
                xa = np.array([float(k) for k in str_sa.split(",")])
                ya = np.array([float(k) for k in str_fa.split(",")])
                res_a = analyze(xa, ya, do_filter)
                
                if "error" in res_a: raise ValueError(f"Subject A: {res_a['error']}")
                
                # Show Warnings A
                if res_a['warnings']:
                    document.getElementById("warn_container").style.display = "block"
                    document.getElementById("warn_a").style.display = "block"
                    w_html = "<span class='warning-icon'>‚ö†Ô∏è</span><div><b>Subject A Alerts:</b><ul style='margin:5px 0 0 0; padding-left:15px;'>"
                    for w in res_a['warnings']: w_html += f"<li>{w}</li>"
                    w_html += "</ul></div>"
                    document.getElementById("warn_a").innerHTML = w_html

                # ANALYZE B
                str_sb = document.getElementById("sb").value.strip()
                str_fb = document.getElementById("fb").value.strip()
                res_b = None
                xb, yb = [], []
                if str_sb and str_fb:
                    xb = np.array([float(k) for k in str_sb.split(",")])
                    yb = np.array([float(k) for k in str_fb.split(",")])
                    res_b = analyze(xb, yb, do_filter)
                    if "error" in res_b: raise ValueError(f"Subject B: {res_b['error']}")
                    
                    # Show Warnings B
                    if res_b['warnings']:
                        document.getElementById("warn_container").style.display = "block"
                        document.getElementById("warn_b").style.display = "block"
                        w_html = "<span class='warning-icon'>‚ö†Ô∏è</span><div><b>Subject B Alerts:</b><ul style='margin:5px 0 0 0; padding-left:15px;'>"
                        for w in res_b['warnings']: w_html += f"<li>{w}</li>"
                        w_html += "</ul></div>"
                        document.getElementById("warn_b").innerHTML = w_html

                # PLOT
                fig, ax = plt.subplots(figsize=(7, 5))
                # Plot A
                ax.scatter(res_a['x_fit'], res_a['y_fit'], color='#d63384', alpha=0.7, label='A (Valid Data)')
                if res_a['n_out'] > 0: ax.scatter(res_a['x_out'], res_a['y_out'], color='red', marker='x', s=100, linewidth=2, label='A (Outlier)', zorder=10)
                ax.plot(res_a['xs'], res_a['ys'], color='#d63384', linewidth=2.5, label='A (Model)')
                ax.fill_between(res_a['xs'], 0, res_a['ys'], where=(res_a['xs']>=res_a['zlo'])&(res_a['xs']<=res_a['zhi']), color='#d63384', alpha=0.1)
                
                # Plot B
                if res_b:
                    ax.scatter(res_b['x_fit'], res_b['y_fit'], color='#0d6efd', alpha=0.7, label='B (Valid Data)')
                    if res_b['n_out'] > 0: ax.scatter(res_b['x_out'], res_b['y_out'], color='red', marker='x', s=100, linewidth=2, label='B (Outlier)', zorder=10)
                    ax.plot(res_b['xs'], res_b['ys'], color='#0d6efd', linewidth=2.5, label='B (Model)')
                    ax.fill_between(res_b['xs'], 0, res_b['ys'], where=(res_b['xs']>=res_b['zlo'])&(res_b['xs']<=res_b['zhi']), color='#0d6efd', alpha=0.1)
                
                ax.set_title("Metabolic Profile Comparison")
                ax.set_xlabel("Intensity")
                ax.set_ylabel("Oxidation (g/min)")
                ax.legend()
                ax.grid(True, alpha=0.25)
                display(fig, target="plot_out", append=False)

                # TABLE
                def safe_get(res, key, fmt="{:.2f}"):
                    if not res: return "-"
                    return fmt.format(res[key])

                rows = ""
                rows += f"<tr><td class

